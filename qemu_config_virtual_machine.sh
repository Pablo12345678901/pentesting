#!/usr/bin/env bash

ISO_PATH="$REPERTOIRE_QEMU_FILES/freedos/freedos.iso"
IMG_PATH="$REPERTOIRE_QEMU_FILES/freedos/freedos.img"
MEMORY_ALLOCATED="8G"
NUMBER_OF_CPU_USED=2

: <<"GENERALTHEORY"
The general form of a QEMU command line can be expressed as:

$ qemu-system-x86_64 \
                [machine opts] \
                [cpu opts] \
                [accelerator opts] \
                [device opts] \
                [backend opts] \
                [interface opts] \
                [boot opts]

Machine : Define the machine type, amount of memory etc

CPU : Type and number/topology of vCPUs. Most accelerators offer a host cpu option which simply passes through your host CPU configuration without filtering out any features.

Accelerator : This will depend on the hypervisor you run. Note that the default is TCG, which is purely emulated, so you must specify an accelerator type to take advantage of hardware virtualization.

Devices : Additional devices that are not defined by default with the machine type.

Backends : Backends are how QEMU deals with the guestâ€™s data, for example how a block device is stored, how network devices see the network or how a serial device is directed to the outside world.

Interfaces : How the system is displayed, how it is managed and controlled or debugged.

Boot : How the system boots, via firmware or direct kernel boot.

GENERALTHEORY

# Adapted line codes
sudo qemu-system-x86_64 \
   -M microvm,x-option-roms=off,pit=off,pic=off,isa-serial=off,rtc=off \
   -enable-kvm -cpu host -m "$MEMORY_ALLOCATED" -smp $NUMBER_OF_CPU_USED \
   -kernel "$ISO_PATH" -append "console=hvc0 root=/dev/vda" \
   -nodefaults -no-user-config -nographic \
   -chardev stdio,id=virtiocon0 \
   -device virtio-serial-device \
   -device virtconsole,chardev=virtiocon0 \
   -drive id=test,file="$IMG_PATH",format=raw,if=none \
   -device virtio-blk-device,drive=test \
   -netdev tap,id=tap0,script=no,downscript=no \
   -device virtio-net-device,netdev=tap0

# Comments about above command :
# Machine :
# -M : machine type supported by QEMU
# x-option-roms=<bool> : Set off to disable loading option ROMs - https://en.wikipedia.org/wiki/Option_ROM
# pit=<OnOffAuto> : Enable i8254 PIT - Programmable Interval Timer (PIT) chip (Intel 8253/8254) basically consists of an oscillator, a prescaler and 3 independent frequency dividers.
# pic=<OnOffAuto> : Enable i8259 PIC - The 8259 Programmable Interrupt Controller (PIC) is one of the most important chips making up the x86 architecture. Without it, the x86 architecture would not be an interrupt driven architecture. The function of the 8259A is to manage hardware interrupts and send them to the appropriate system interrupt. This allows the system to respond to devices needs without loss of time (from polling the device, for instance).
# isa-serial=<bool> : Set off to disable the instantiation an ISA serial port - Industry Standard Architecture (ISA) is the 16-bit internal bus of IBM PC/AT and similar computers based on the Intel 80286 and its immediate successors during the 1980s.
# rtc=<OnOffAuto> : Enable MC146818 RTC (Real-Time Clock from Motorola


# -enable-kvm : Kernel-based Virtual Machine (KVM) is a free and open-source virtualization module in the Linux kernel that allows the kernel to function as a hypervisor.
# -smp : Symmetric multiprocessing or shared-memory multiprocessing (SMP)


: <<"Originallinecodes"
# microvm : https://www.qemu.org/docs/master/system/i386/microvm.html
# "This is an example of a VM with all optional legacy features disabled:"

qemu-system-x86_64 \
   -M microvm,x-option-roms=off,pit=off,pic=off,isa-serial=off,rtc=off \
   -enable-kvm -cpu host -m 512m -smp 2 \
   -kernel vmlinux -append "console=hvc0 root=/dev/vda" \
   -nodefaults -no-user-config -nographic \
   -chardev stdio,id=virtiocon0 \
   -device virtio-serial-device \
   -device virtconsole,chardev=virtiocon0 \
   -drive id=test,file=test.img,format=raw,if=none \
   -device virtio-blk-device,drive=test \
   -netdev tap,id=tap0,script=no,downscript=no \
   -device virtio-net-device,netdev=tap0

Originallinecodes
